name: Create resources
on:
    workflow_dispatch:

permissions:
    id-token: write
    contents: read

env:
  environment: ${{ vars.ENVIRONMENT }}

jobs:
    terraform_apply:
        runs-on: ubuntu-latest
        env: 
            bucket: ${{ secrets.BACKEND_S3_BUCKET}}
        steps:
            - name: Checkout the code
              uses: actions/checkout@v4
            
            - name: Configure AWS
              uses: aws-actions/configure-aws-credentials@v5
              with:
                role-to-assume: ${{ secrets.OIDC_IAM_ROLE }}
                aws-region: us-east-1
            
            - name: Setup terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.7.0

            - name: Terraform apply
              run: ./scripts/apply.sh $environment